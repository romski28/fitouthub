generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                  String        @id @default(cuid())
  nickname            String        @unique
  firstName           String
  surname             String
  chineseName         String?
  email               String        @unique
  mobile              String?
  passwordHash        String
  passwordResetToken  String?
  passwordResetExpiry DateTime?
  emailVerified       Boolean       @default(false)
  verificationToken   String?
  role                String        @default("client")
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  professional        Professional?
  projects            Project[]
  assistRequests      ProjectAssistRequest[] @relation("UserAssistRequests")
  privateChatThread   PrivateChatThread?
  privateChatMessagesSent PrivateChatMessage[] @relation("UserSender")
}

model Tradesman {
  id              String           @id @default(cuid())
  title           String           @unique
  category        String
  emoji           String?
  description     String?
  featured        Boolean          @default(false)
  image           String?
  jobs            String[]
  aliases         String[]         @default([])
  professionType  String?
  enabled         Boolean          @default(true)
  usageCount      Int              @default(0)
  sortOrder       Int              @default(999)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  serviceMappings ServiceMapping[]

  @@index([category])
  @@index([enabled])
  @@index([professionType])
}

model Professional {
  id                   String                @id @default(cuid())
  userId               String?               @unique
  status               String                @default("pending")
  rating               Float                 @default(0)
  registrationDate     DateTime              @default(now())
  fullName             String?
  businessName         String?
  serviceArea          String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  email                String                @unique
  phone                String
  professionType       String
  additionalData       Json?
  locationPrimary      String?
  locationSecondary    String?
  locationTertiary     String?
  servicePrimaries     String[]              @default([])
  serviceSecondaries   String[]              @default([])
  primaryTrade         String?
  profileImages        String[]              @default([])
  suppliesOffered      String[]              @default([])
  tradesOffered        String[]              @default([])
  passwordHash         String?
  emailTokens          EmailToken[]
  user                 User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectProfessionals ProjectProfessional[]
  reports              ProfessionalReport[]
  referenceProjects    ProfessionalReferenceProject[]
  privateChatThread    PrivateChatThread?
  privateChatMessagesSent PrivateChatMessage[] @relation("ProfessionalSender")
}

model Project {
  id                     String                @id @default(cuid())
  status                 String                @default("pending")
  clientId               String?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  userId                 String?
  budget                 Decimal?              @db.Decimal(12, 2)
  clientName             String
  contractorName         String?
  notes                  String?
  projectName            String
  tradesRequired         String[]              @default([])
  region                 String
  startDate              DateTime?
  endDate                DateTime?
  isEmergency            Boolean               @default(false)
  contractorContactName  String?
  contractorContactPhone String?
  contractorContactEmail String?
  emailTokens            EmailToken[]
  client                 Client?               @relation(fields: [clientId], references: [id])
  user                   User?                 @relation(fields: [userId], references: [id])
  professionals          ProjectProfessional[]
  assistRequests         ProjectAssistRequest[]
  chatThread             ProjectChatThread?
  financialTransactions  FinancialTransaction[]
}

model ProjectProfessional {
  id                    String       @id @default(cuid())
  projectId             String
  professionalId        String
  status                String       @default("pending")
  respondedAt           DateTime?
  quoteAmount           Decimal?     @db.Decimal(12, 2)
  quoteNotes            String?
  quotedAt              DateTime?
  directContactShared   Boolean      @default(false)
  directContactSharedAt DateTime?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  professional          Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  project               Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages              Message[]
  invoice               Invoice?
  advancePaymentRequest AdvancePaymentRequest?
  financialTransactions FinancialTransaction[]

  @@unique([projectId, professionalId])
  @@index([projectId])
  @@index([professionalId])

}

model ProfessionalReferenceProject {
  id             String   @id @default(uuid()) @db.Uuid
  professionalId String
  title          String
  description    String?
  imageUrls      String[] @default([])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([professionalId])
}

model ProfessionalReport {
  id              String       @id @default(cuid())
  professionalId  String
  reporterUserId  String?
  comments        String
  status          String       @default("new") // new | reviewed | resolved
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  professional    Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([professionalId])
  @@index([status])
}

model EmailToken {
  id             String       @id @default(cuid())
  token          String       @unique @default(cuid())
  projectId      String
  professionalId String
  action         String
  expiresAt      DateTime
  usedAt         DateTime?
  createdAt      DateTime     @default(now())
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([projectId])
}

model Client {
  id        String    @id @default(cuid())
  name      String
  email     String?   @unique
  phone     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  projects  Project[]
}

model Pattern {
  id        String   @id @default(cuid())
  name      String
  pattern   String
  matchType String
  category  String
  notes     String?
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mapsTo    String?

  @@index([category])
  @@index([matchType])
}

model Message {
  id                    String    @id @default(cuid())
  projectProfessionalId String
  senderType            String // 'professional' | 'client'
  senderProfessionalId  String?
  senderClientId        String?
  content               String
  createdAt             DateTime  @default(now())
  readByProfessionalAt  DateTime?
  readByClientAt        DateTime?

  projectProfessional ProjectProfessional @relation(fields: [projectProfessionalId], references: [id], onDelete: Cascade)

  @@index([projectProfessionalId])
  @@index([senderType])
  @@index([createdAt])
}

model ProjectAssistRequest {
  id         String   @id @default(cuid())
  projectId  String
  userId     String?
  status     String   @default("open") // open | in_progress | closed
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  project    Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user       User?    @relation("UserAssistRequests", fields: [userId], references: [id], onDelete: SetNull)
  messages   AssistMessage[]

  @@index([projectId])
  @@index([status])
}

model AssistMessage {
  id               String   @id @default(cuid())
  assistRequestId  String
  senderType       String   // client | foh
  senderUserId     String?
  content          String
  createdAt        DateTime @default(now())
  readByFohAt      DateTime?
  readByClientAt   DateTime?
  assistRequest    ProjectAssistRequest @relation(fields: [assistRequestId], references: [id], onDelete: Cascade)

  @@index([assistRequestId])
  @@index([senderType])
  @@index([createdAt])
}

// FOH Private Support Threads (logged-in users & professionals)
model PrivateChatThread {
  id              String   @id @default(cuid())
  userId          String?  @unique // null for professionals
  professionalId  String?  @unique // null for clients
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  messages        PrivateChatMessage[]

  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  professional    Professional? @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([professionalId])
  @@index([updatedAt])
}

model PrivateChatMessage {
  id              String   @id @default(cuid())
  threadId        String
  senderType      String   // 'user' | 'professional' | 'foh'
  senderUserId    String?
  senderProId     String?
  content         String
  createdAt       DateTime @default(now())
  readByFohAt     DateTime?
  thread          PrivateChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  userSender      User?    @relation("UserSender", fields: [senderUserId], references: [id], onDelete: SetNull)
  proSender       Professional? @relation("ProfessionalSender", fields: [senderProId], references: [id], onDelete: SetNull)

  @@index([threadId])
  @@index([senderType])
  @@index([createdAt])
}

// Anonymous FOH Support Threads
model AnonymousChatThread {
  id              String   @id @default(cuid())
  sessionId       String   @unique // Anonymous session ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  messages        AnonymousChatMessage[]

  @@index([createdAt])
}

model AnonymousChatMessage {
  id              String   @id @default(cuid())
  threadId        String
  senderType      String   // 'anonymous' | 'foh'
  content         String
  createdAt       DateTime @default(now())
  thread          AnonymousChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([createdAt])
}

// Project Chat Threads (post-award shared team chat)
model ProjectChatThread {
  id              String   @id @default(cuid())
  projectId       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  messages        ProjectChatMessage[]
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId])
  @@index([projectId])
  @@index([updatedAt])
}

model ProjectChatMessage {
  id              String   @id @default(cuid())
  threadId        String
  senderType      String   // 'client' | 'professional' | 'foh'
  senderUserId    String?
  senderProId     String?
  content         String
  createdAt       DateTime @default(now())
  thread          ProjectChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([threadId])
  @@index([senderType])
  @@index([createdAt])
}

model ServiceMapping {
  id         String   @id @default(cuid())
  keyword    String   @unique // e.g., "leaky pipe", "fix toilet"
  tradeId    String
  confidence Int      @default(100) // 0-100, for fuzzy matching confidence
  enabled    Boolean  @default(true)
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  trade      Tradesman @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([keyword])
  @@index([tradeId])
  @@index([enabled])
}
model Invoice {
  id                    String       @id @default(cuid())
  projectProfessionalId String
  amount                Decimal      @db.Decimal(12, 2)
  paymentStatus         String       @default("pending") // pending | paid | cancelled
  paidAt                DateTime?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  projectProfessional   ProjectProfessional @relation(fields: [projectProfessionalId], references: [id], onDelete: Cascade)

  @@unique([projectProfessionalId])
  @@index([paymentStatus])
}

model AdvancePaymentRequest {
  id                    String       @id @default(cuid())
  projectProfessionalId String
  requestType           String       // "fixed" (amount) or "percentage"
  requestAmount         Decimal      @db.Decimal(12, 2) // dollar amount
  requestPercentage     Float? // percentage of invoice amount (0-100)
  status                String       @default("pending") // pending | approved | rejected
  approvedAmount        Decimal?     @db.Decimal(12, 2)
  rejectionReason       String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  projectProfessional   ProjectProfessional @relation(fields: [projectProfessionalId], references: [id], onDelete: Cascade)

  @@unique([projectProfessionalId])
  @@index([status])
}

model FinancialTransaction {
  id                    String       @id @default(cuid())
  projectId             String
  projectProfessionalId String?      // null for escrow deposits
  type                  String       // "escrow_deposit" | "advance_payment_request" | "advance_payment_approval" | "advance_payment_rejection" | "release_payment" | "escrow_confirmation"
  description           String       // Human-readable description
  amount                Decimal      @db.Decimal(12, 2)
  status                String       @default("pending") // pending | confirmed | completed | rejected
  requestedBy           String?      // user_id or professional_id
  requestedByRole       String?      // "client" | "professional" | "admin"
  approvedBy            String?      // admin_id
  approvedAt            DateTime?
  notes                 String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  project               Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectProfessional   ProjectProfessional? @relation(fields: [projectProfessionalId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectProfessionalId])
  @@index([status])
  @@index([type])
}