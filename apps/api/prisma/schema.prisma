generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String        @id @default(cuid())
  nickname            String        @unique
  firstName           String
  surname             String
  chineseName         String?
  email               String        @unique
  mobile              String?
  passwordHash        String
  passwordResetToken  String?
  passwordResetExpiry DateTime?
  emailVerified       Boolean       @default(false)
  verificationToken   String?
  role                String        @default("client")
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  professional        Professional?
  projects            Project[]
}

model Tradesman {
  id              String           @id @default(cuid())
  title           String           @unique
  category        String
  emoji           String?
  description     String?
  featured        Boolean          @default(false)
  image           String?
  jobs            String[]
  aliases         String[]         @default([])
  professionType  String?
  enabled         Boolean          @default(true)
  usageCount      Int              @default(0)
  sortOrder       Int              @default(999)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  serviceMappings ServiceMapping[]

  @@index([category])
  @@index([enabled])
  @@index([professionType])
}

model Professional {
  id                   String                @id @default(cuid())
  userId               String?               @unique
  status               String                @default("pending")
  rating               Float                 @default(0)
  registrationDate     DateTime              @default(now())
  fullName             String?
  businessName         String?
  serviceArea          String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  email                String                @unique
  phone                String
  professionType       String
  additionalData       Json?
  locationPrimary      String?
  locationSecondary    String?
  locationTertiary     String?
  servicePrimaries     String[]              @default([])
  serviceSecondaries   String[]              @default([])
  primaryTrade         String?
  suppliesOffered      String[]              @default([])
  tradesOffered        String[]              @default([])
  passwordHash         String?
  emailTokens          EmailToken[]
  user                 User?                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  projectProfessionals ProjectProfessional[]
  reports              ProfessionalReport[]
}

model Project {
  id                     String                @id @default(cuid())
  status                 String                @default("pending")
  clientId               String?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  userId                 String?
  budget                 Decimal?              @db.Decimal(12, 2)
  clientName             String
  contractorName         String?
  notes                  String?
  projectName            String
  tradesRequired         String[]              @default([])
  region                 String
  startDate              DateTime?
  endDate                DateTime?
  isEmergency            Boolean               @default(false)
  contractorContactName  String?
  contractorContactPhone String?
  contractorContactEmail String?
  emailTokens            EmailToken[]
  client                 Client?               @relation(fields: [clientId], references: [id])
  user                   User?                 @relation(fields: [userId], references: [id])
  professionals          ProjectProfessional[]
}

model ProjectProfessional {
  id                    String       @id @default(cuid())
  projectId             String
  professionalId        String
  status                String       @default("pending")
  respondedAt           DateTime?
  quoteAmount           Decimal?     @db.Decimal(12, 2)
  quoteNotes            String?
  quotedAt              DateTime?
  directContactShared   Boolean      @default(false)
  directContactSharedAt DateTime?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  professional          Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  project               Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages              Message[]

  @@unique([projectId, professionalId])
  @@index([projectId])
  @@index([professionalId])
}

model ProfessionalReport {
  id              String       @id @default(cuid())
  professionalId  String
  reporterUserId  String?
  comments        String
  status          String       @default("new") // new | reviewed | resolved
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  professional    Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)

  @@index([professionalId])
  @@index([status])
}

model EmailToken {
  id             String       @id @default(cuid())
  token          String       @unique @default(cuid())
  projectId      String
  professionalId String
  action         String
  expiresAt      DateTime
  usedAt         DateTime?
  createdAt      DateTime     @default(now())
  professional   Professional @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([projectId])
}

model Client {
  id        String    @id @default(cuid())
  name      String
  email     String?   @unique
  phone     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  projects  Project[]
}

model Pattern {
  id        String   @id @default(cuid())
  name      String
  pattern   String
  matchType String
  category  String
  notes     String?
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  mapsTo    String?

  @@index([category])
  @@index([matchType])
}

model Message {
  id                    String    @id @default(cuid())
  projectProfessionalId String
  senderType            String // 'professional' | 'client'
  senderProfessionalId  String?
  senderClientId        String?
  content               String
  createdAt             DateTime  @default(now())
  readByProfessionalAt  DateTime?
  readByClientAt        DateTime?

  projectProfessional ProjectProfessional @relation(fields: [projectProfessionalId], references: [id], onDelete: Cascade)

  @@index([projectProfessionalId])
  @@index([senderType])
  @@index([createdAt])
}

model ServiceMapping {
  id         String   @id @default(cuid())
  keyword    String   @unique // e.g., "leaky pipe", "fix toilet"
  tradeId    String
  confidence Int      @default(100) // 0-100, for fuzzy matching confidence
  enabled    Boolean  @default(true)
  usageCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  trade      Tradesman @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@index([keyword])
  @@index([tradeId])
  @@index([enabled])
}
